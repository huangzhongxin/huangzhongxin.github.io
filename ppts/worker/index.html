<!doctype html><html><head><meta charset=UTF-8><title>Web Worker分享 - By 黄种鑫</title><link rel=stylesheet href=https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdn.staticfile.org/prism/1.15.0/themes/prism.min.css><link rel=stylesheet href=https://cdn.staticfile.org/KaTeX/0.10.0-rc.1/katex.min.css><link href=./css/chunk-vendors.4e4765ff.css rel=stylesheet></head><body><div><article id=webslides><section slide class="slide bg-black-blue aligncenter" image="https://source.unsplash.com/C1HhAQrbykQ/ .light"><span class="background light" style="background-image:url('https://source.unsplash.com/C1HhAQrbykQ/')"></span><div class=wrap wrap=true><h1 class=text-shadow>Web Worker分享</h1><p class=text-intro>By 黄种鑫</p><p>2023.06.30</p></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>什么是 Web Worker</h2><hr><p>Web Worker 是一种在浏览器端运行的 JavaScript 程序，可以在单独的线程中执行 JavaScript 代码，不会影响页面主线程的运行。</p></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>Web Worker 与主线程的区别</h2><hr><ul><li>Web Worker 可以在单独的线程中执行代码，不会阻塞页面主线程。</li><li>Web Worker 不能直接访问 DOM，只能与主线程通信，主线程再进行 DOM 操作。</li><li>Web Worker 与主线程之间的通信只能通过消息传递，不能共享变量。</li></ul></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>使用 Web Worker 的场景</h2><hr><ul><li>大量计算密集型的任务，如图像处理、数据分析等。</li><li>需要长时间运行的任务，如视频转码、音频处理等。</li><li>在后台执行任务，不影响用户的操作体验，如离线数据处理、后台消息推送等。</li></ul><p><a href=https://codesandbox.io/s/no-worker-m4y8kq target=_blank>不用Worker</a></p><p><a href=https://codesandbox.io/s/with-worker-53crys target=_blank>使用Worker</a></p></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>Web Worker 的使用</h2><hr><h3>创建Worker</h3><p>创建 <code>worker</code> 只需要通过 <code>new</code> 调用 <code>Worker()</code> 构造函数即可，它接收两个参数</p><pre class=language-javascript><code class=language-javascript><span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
</code></pre><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>path</td><td>有效的js脚本的地址，必须遵守同源策略。如果违反同源策略，会抛出 <code>SECURITY_ERR</code> 类型错误</td></tr><tr><td>options.type</td><td>可选，用以指定 worker 类型。该值可以是 <code>classic</code> 或 <code>module</code>。 默认值 <code>classic</code></td></tr><tr><td>options.credentials</td><td>可选，用以指定 worker 凭证。该值可以是 <code>omit</code>, <code>same-origin</code>, <code>include</code>。如果未指定，或者 type 是 <code>classic</code>，将使用默认值 <code>omit</code> (不要求凭证)</td></tr><tr><td>options.name</td><td>可选，在 <code>DedicatedWorkerGlobalScope</code> 的情况下，用来表示 worker 的 scope 的一个 DOMString 值，主要用于调试目的。</td></tr></tbody></table></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>Web Worker 的通信方式</h2><hr><p><img src=./img/message.webp alt=""></p></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>关闭Worker <a href="https://codesandbox.io/s/worker-close-x3hss7?file=/src/App.tsx" target=_blank>实例</a></h2><hr><pre class=language-javascript><code class=language-javascript><span class="token comment">// main.js（主线程）</span>
<span class="token keyword">const</span> myWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'/worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建worker</span>
myWorker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭worker</span>

<span class="token comment">// worker.js（worker线程）</span>
self<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接执行close方法</span>
</code></pre><p>无论是在主线程关闭 worker，还是在 worker 线程内部关闭 worker，worker 线程当前的 <code>Event Loop</code> 中的任务会继续执行。至于 worker 线程<strong>下一个</strong> <code>Event Loop</code> 中的任务，则会被<strong>直接忽略</strong>，不会继续执行。但二者存在区别，区别如下：</p><table><thead><tr><th>方法</th><th>连接断开时机</th><th>Worker中当前<code>Event Loop</code>中的消息能否接收</th></tr></thead><tbody><tr><td>主线程terminate()</td><td>立即</td><td>不能</td></tr><tr><td>worker线程close()</td><td>worker线程中当前<code>Event Loop</code>执行完毕时</td><td>可以</td></tr></tbody></table></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>Worker 中引用其他文件</h2><hr><h3>importScript <a href=https://codesandbox.io/s/worker-importscripts-yqvqqv target=_blank>实例</a></h3><h6><em>注意：</em> 不受同源限制</h6><hr><h3>ES Module <a href="https://codesandbox.io/s/worker-module-x2nmj6?file=/src/App.tsx:203-231" target=_blank>实例</a></h3><h6>调用构造函数时，设置<code>type</code>为<code>module</code></h6></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>支持的数据类型</h2><hr><p><code>postMessage()</code> 传递的数据可以是由<a href=https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm target=_blank>结构化克隆算法</a>处理的任何值或 JavaScript 对象，包括循环引用。</p><table><thead><tr><th>支持的类型</th></tr></thead><tbody><tr><td>除<code>symbol</code>外的所有基本类型</td></tr><tr><td><code>Map</code>、<code>Array</code>、<code>TypedArray</code>、<code>Blob</code>、<code>Audio</code>等JavaScript类型</td></tr><tr><td><code>Object</code>仅支持普通对象（如字面量）</td></tr><tr><td>部分<code>Error</code>对象</td></tr></tbody></table><hr><h6>不支持的</h6><p><code>Function</code>、<code>DOM</code>节点</p><hr><h6>某些特定参数不会保留</h6><p>6.1 <code>RegExp</code>对象的 <code>lastIndex</code> 字段</p><p>6.2 属性描述符，<code>setters</code> 以及 <code>getters</code>（以及其他类似元数据的功能）同样不会被复制。例如，如果一个对象用属性描述符标记为 <code>read-only</code>，它将会被复制为 <code>read-write</code></p><p>6.3 原形链上的属性也不会被追踪以及复制</p></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>Shared Worker <a href="https://codesandbox.io/s/sharedworker-h5kkzx?file=/src/App.tsx" target=_blank>实例</a></h2><hr><p><code>SharedWorker</code>是一中特殊的Worker，可以在多个窗口或标签页之间共享一个线程。创建及使用上与Worker类似，不同点在于，主线程与 <code>SharedWorker</code> 线程是通过<a href=https://developer.mozilla.org/zh-CN/docs/Web/API/MessagePort target=_blank>MessagePort</a>建立起链接，数据通讯方法都挂载在<code>SharedWorker.port</code>上。</p></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>注意点</h2><p>采用 <code>addEventListener</code> 来接收 <code>message</code> 事件，那么在主线程初始化<code>SharedWorker()</code>后，<strong>还要手动调用</strong> <code>SharedWorker.port.start()</code> 方法来手动开启端口。</p><pre class=language-js><code class=language-js><span class="token keyword">const</span> myWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

myWorker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开启端口</span>

myWorker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>但是，如果采用 <code>onmessage</code> 方法，则默认开启端口，<strong>不需要再手动调用</strong>SharedWorker.port.start()方法</p><pre class=language-js><code class=language-js><span class="token keyword">const</span> myWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

myWorker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">msg</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>调试SharedWorker</h2><hr><p><code>chrome://inspect</code>中开启 <img src=./img/devtool.png alt=""></p></div></section><section slide class=slide :class="size-50 aligncenter"><div class="wrap size-50 aligncenter" wrap=true><h2>参考资料</h2><hr><ul><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API target=_blank>MDN Web Worker</a></li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker target=_blank>MDN Shared Worker</a></li></ul></div></section></article></div><script src=https://cdn.staticfile.org/echarts/4.8.0/echarts.min.js></script><script>window.pluginsOptions = {}



    window.webslidesOptions = {}


document.addEventListener('DOMContentLoaded', () => {
    let isPrintMode = false;
    if(~location.search.indexOf('print-pdf')){
        isPrintMode = true;
        WebSlides.registerPlugin('scroll', function(){});
    }
    const wsOptions = {
        loop: false
    };
    if(window.webslidesOptions){
        for (let i in webslidesOptions){
            if(webslidesOptions.hasOwnProperty(i)){
                wsOptions[i] = webslidesOptions[i];
            }
        }
    }
    const ws = new WebSlides(wsOptions)

    window.wsInstance = ws;
    if(isPrintMode){
        ws.slides.forEach(s=>s.show())
    }
}, false)</script><script src=./js/chunk-vendors.js></script><script src=./js/worker.js></script></body></html>